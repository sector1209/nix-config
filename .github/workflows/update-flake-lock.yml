name: "Flake.lock: update Nix dependencies"

on:
    workflow_dispatch: # allows manual triggering
    schedule:
        - cron: "0 0 * * *" # every day at 12:00 AM

jobs:
    nix-flake-update:
        permissions:
            contents: write
            id-token: write
            issues: write
            pull-requests: write
        runs-on: ubuntu-latest
        steps:
            - name: Access private repository
              uses: webfactory/ssh-agent@master
              with:
                  ssh-private-key: ${{ secrets.SECRETS_REPO_PRIVATE_KEY }}
            - name: Configure SSH for private repo
              run: |
                  mkdir -p ~/.ssh
                  cat >> ~/.ssh/config << EOF
                  Host github.com-nix-secrets
                    HostName github.com
                    User git
                    IdentityFile ~/.ssh/id_ed25519
                    StrictHostKeyChecking no
                  EOF
                  chmod 600 ~/.ssh/config
            - uses: actions/checkout@v4
            - uses: DeterminateSystems/determinate-nix-action@v3
            - id: update
              uses: DeterminateSystems/update-flake-lock@main
              with:
                  commit-msg: "chore(flake.lock): update"
                  pr-title: "chore(flake.lock): update"
                  pr-labels: | # Labels to be set on the PR
                      dependencies
                      automated
                      auto-merge
                  token: "${{ secrets.GH_TOKEN_FOR_UPDATES }}"
            - name: Merge
              run: gh pr merge --auto "${{ steps.update.outputs.pull-request-number }}" --rebase
              env:
                  GITHUB_TOKEN: ${{secrets.GH_TOKEN_FOR_UPDATES}}
              if: ${{ steps.update.outputs.pull-request-number != '' }}
